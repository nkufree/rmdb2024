# 数据库设计与实现文档

## 设计思路

### 存储管理

#### 磁盘管理

磁盘管理中需要提供对磁盘上的文件操作的功能：

1. 创建文件
2. 打开文件
3. 关闭文件
4. 销毁文件
5. 写入文件
6. 读取文件

由于在缓冲池中文件以页的方式进行管理，所以此处的写入和读取文件也按照页的方式进行。

#### 缓冲池管理

为了便于对文件进行更加细致化的管理，数据库自己实现了一个基于分页机制的缓冲池，需要提供以下功能：

1. 分配新页
2. 获取页
3. 淘汰页
4. 更新页
5. 取消固定页
6. 删除页
7. 将一页写入磁盘
8. 将所有页写入磁盘

在选择淘汰页的过程中，需要考虑缓冲池替换策略，实现以下功能：

1. 淘汰页
2. 固定页
3. 取消固定页

#### 记录管理

为了实现更加精细化的管理，需要实现记录管理器，提供以下功能：

1. 获取记录
2. 插入记录
3. 删除记录
4. 更新记录

其中插入记录需要考虑自动选择一个空闲位置插入，和在指定位置插入（用于事务异常处理）。

#### 记录遍历

为了方便后续查询执行，还需要提供遍历表中的所有记录的接口。

### 查询执行

#### DDL语句

DDL语句包括以下内容：

1. 创建表：创建表文件，初始化表信息，将表添加到数据库打开表列表中。
2. 删除表：关闭表文件，删除索引文件，删除表文件，更新数据库信息。

#### DML语句

DML语句包括以下内容：

1. `insert`语句：构建插入数据对应的二进制数据，写入对应的表和索引中。
2. `delete`语句：从表中查询所有符合条件的记录，删除记录和对应的索引。
3. `update`语句：从表中查询所有符合条件的记录，更新记录和对应的索引。

#### DQL语句

DQL语句需要实现`select`语句，大体上可以分为三个算子：记录遍历、投影、连接。

记录遍历算子需要从表中取出符合条件的记录，投影算子需要将记录转换为需要查询的字段，如果有连接查询则需要使用连接算子拼接字段。

### 唯一索引

#### 索引的创建、删除和展示

1. 创建索引：创建并打开索引文件，将表中原有的数据插入索引中。
2. 删除索引：关闭并删除索引索引文件。
3. 展示索引：遍历表的所有索引并输出。

#### 索引查询

我们实现的是 B+ 树索引，首先需要实现索引匹配规则，使用最长匹配的索引进行查询，对外提供比较重要的功能如下：

1. 查找大于或等于指定键所属的叶子节点。
2. 查找大于指定键所属的叶子节点。
3. 插入指定键。
4. 删除指定键。

#### 索引维护

需要考虑唯一索引的约束性：

1. 插入键时，如果键已经存在则抛出异常。
2. 更新键时，如果更新后的键已存在则抛出异常，如果更新后与更新前的键相同则不抛出异常。


### 聚合函数与分组统计



### 不相关子查询



### 事务控制语句





### 冲突可串行化



### 基于静态检查点的故障恢复



## 系统框架



## 实现重点

### B+树索引


### 事务控制


### 冲突可串行化


### 故障恢复



## 代码注释



## 遇到问题

### 内存泄漏

在不断接受事务的过程中，由于部分使用`new`分配出去的空间没有释放，会导致数据库内存占用不断升高，经过排查后找出比较严重的问题：

1. 事务修改记录的操作没有释放
2. 在索引查询中部分结点管理没有释放
3. 在日志管理中没有释放表名所占空间
4. 事务结束后也一直存放在事务管理表中没有释放

在后续的过程中我们对以上问题涉及的对象在适当的位置进行释放。

## 性能优化

### `count(*)` 优化

我们对全表的记录条数统计进行优化，直接对表中所有页面的记录数进行求和，省去遍历表中记录的步骤。